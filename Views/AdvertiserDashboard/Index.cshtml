@* @model AdSystem.ViewModels.AdvertiserDashboardViewModel
@{
    ViewData["Title"] = "Advertiser Dashboard";
}

<h2 class="mb-4">📢 Advertiser Dashboard</h2>

<div class="row g-3 mb-4">
    <div class="col-md-3">
        <div class="card text-center shadow-sm">
            <div class="card-body">
                <h5>Total Ads</h5>
                <h3>@Model.TotalAds</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center shadow-sm bg-success bg-opacity-25">
            <div class="card-body">
                <h5>Approved Ads</h5>
                <h3>@Model.ApprovedAds</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center shadow-sm bg-warning bg-opacity-25">
            <div class="card-body">
                <h5>Pending Ads</h5>
                <h3>@Model.PendingAds</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center shadow-sm bg-info bg-opacity-25">
            <div class="card-body">
                <h5>Clicks</h5>
                <h3>@Model.TotalClicks</h3>
            </div>
        </div>
    </div>
</div>

<div class="row g-3 mb-4">
    <div class="col-md-6">
        <div class="card text-center shadow-sm">
            <div class="card-body">
                <h5>Impressions</h5>
                <h3>@Model.TotalImpressions</h3>
            </div>
        </div>
    </div>
</div>

<hr />

<h4>📊 Performance Overview</h4>
<div class="card p-4 shadow-sm">
    <canvas id="adChart" height="100" width="100"></canvas>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        const ctx = document.getElementById('adChart');
        new Chart(ctx, {
            type: 'pie',
            data: {
                labels: ['Approved Ads', 'Pending Ads'],
                datasets: [{
                    data: [@Model.ApprovedAds, @Model.PendingAds],
                    backgroundColor: ['#4caf50', '#ff9800']
                }]
            }
        });
    </script>
} *@
@model AdSystem.ViewModels.AdvertiserDashboardViewModel
@{
    ViewData["Title"] = "لوحة المعلن";
}

<!-- Page Header -->
<div class="page-header">
    <h1 class="page-title">لوحة المعلن</h1>
    <p class="page-subtitle">تتبع أداء إعلاناتك ونتائج الحملات</p>
</div>

<!-- Stats Cards -->
<div class="row g-4 mb-4">
    <div class="col-xl-3 col-md-6">
        <div class="stat-card">
            <div class="stat-card-icon primary">
                <i class="bi bi-megaphone"></i>
            </div>
            <div class="stat-card-title">إجمالي الإعلانات</div>
            <div class="stat-card-value">@Model.TotalAds</div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6">
        <div class="stat-card">
            <div class="stat-card-icon success">
                <i class="bi bi-check-circle"></i>
            </div>
            <div class="stat-card-title">الإعلانات المفعلة</div>
            <div class="stat-card-value">@Model.ApprovedAds</div>
            <div class="stat-card-change positive">
                <i class="bi bi-check"></i>
                <span>جاهز للعرض</span>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6">
        <div class="stat-card">
            <div class="stat-card-icon warning">
                <i class="bi bi-clock-history"></i>
            </div>
            <div class="stat-card-title">بانتظار الموافقة</div>
            <div class="stat-card-value">@Model.PendingAds</div>
            @if (Model.PendingAds > 0)
            {
                <div class="stat-card-change negative">
                    <i class="bi bi-hourglass-split"></i>
                    <span>قيد المراجعة</span>
                </div>
            }
        </div>
    </div>

    <div class="col-xl-3 col-md-6">
        <div class="stat-card">
            <div class="stat-card-icon error">
                <i class="bi bi-eye"></i>
            </div>
            <div class="stat-card-title">إجمالي المشاهدات</div>
            <div class="stat-card-value">@Model.TotalImpressions.ToString("N0")</div>
        </div>
    </div>
</div>

<!-- Performance Metrics -->
<div class="row g-4 mb-4">
    <div class="col-xl-4 col-md-6">
        <div class="card">
            <div class="card-body">
                <div class="d-flex align-items-center justify-content-between mb-3">
                    <div>
                        <div class="text-secondary small mb-1">إجمالي النقرات</div>
                        <h3 class="mb-0">@Model.TotalClicks.ToString("N0")</h3>
                    </div>
                    <div class="stat-card-icon info" style="width: 56px; height: 56px; font-size: 24px;">
                        <i class="bi bi-cursor-fill"></i>
                    </div>
                </div>
                <div class="d-flex align-items-center gap-2">
                    <span class="badge bg-info">نشط</span>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-4 col-md-6">
        <div class="card">
            <div class="card-body">
                <div class="d-flex align-items-center justify-content-between mb-3">
                    <div>
                        <div class="text-secondary small mb-1">معدل النقر (CTR)</div>
                        <h3 class="mb-0">
                            @if (Model.TotalImpressions > 0)
                            {
                                @(Math.Round((double)Model.TotalClicks / Model.TotalImpressions * 100, 2))
                            
                                <text>%</text>
                            }
                            else
                            {
                                <text>0%</text>
                            }
                        </h3>
                    </div>
                    <div class="stat-card-icon success" style="width: 56px; height: 56px; font-size: 24px;">
                        <i class="bi bi-graph-up-arrow"></i>
                    </div>
                </div>
                <div class="progress" style="height: 6px;">
                    <div class="progress-bar bg-success" role="progressbar"
                         style="width: @(Model.TotalImpressions > 0 ? Math.Min(Math.Round((double)Model.TotalClicks / Model.TotalImpressions * 100, 2), 100) : 0)%"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-4 col-md-6">
        <div class="card">
            <div class="card-body">
                <div class="d-flex align-items-center justify-content-between mb-3">
                    <div>
                        <div class="text-secondary small mb-1">متوسط المشاهدات لكل إعلان</div>
                        <h3 class="mb-0">
                            @if (Model.TotalAds > 0)
                            {
                                @Math.Round((double)Model.TotalImpressions / Model.TotalAds, 0).ToString("N0")
                            }
                            else
                            {
                                <text>0</text>
                            }
                        </h3>
                    </div>
                    <div class="stat-card-icon warning" style="width: 56px; height: 56px; font-size: 24px;">
                        <i class="bi bi-bar-chart-line"></i>
                    </div>
                </div>
                <div class="text-secondary small">لكل إعلان</div>
            </div>
        </div>
    </div>
</div>
<div class="col-xl-4 col-md-6">
    <div class="card">
        <div class="card-body">
            <div class="d-flex align-items-center justify-content-between mb-3">
                <div>
                    <div class="text-secondary small mb-1">تكلفة الإعلان</div>
                    <h3 class="mb-0">@Model.EstimatedSpend.ToString("N2") <small>دولار</small></h3>
                </div>
                <div class="stat-card-icon primary" style="width: 56px; height: 56px; font-size: 24px;">
                    <i class="bi bi-cash-stack"></i>
                </div>
            </div>

            <ul class="list-unstyled small text-secondary">
                <li>تكلفة لكل ألف ظهور (CPM): <strong>@Model.AppliedCPM.ToString("N2") دولار</strong></li>
                <li>تكلفة لكل نقرة (CPC): <strong>@Model.AppliedCPC.ToString("N2") دولار</strong></li>
                <li>نوع التسعير المستخدم: <strong>@Model.PricingRuleType</strong></li>

                @if (Model.PricingRuleType == "Country")
                {
                    <li>الدولة: <strong>@Model.PricingCountry</strong></li>
                }
                @if (Model.PricingRuleType == "City")
                {
                    <li>المدينة: <strong>@Model.PricingCity</strong></li>
                }
            </ul>

            <div class="alert alert-info mt-3 mb-0 small">
                <i class="bi bi-info-circle"></i>
                هذا مبلغ تقديري بناءً على المشاهدات والنقرات الحالية.
            </div>
        </div>
    </div>
</div>
<div class="card mt-4">
    <div class="card-header">
        <h5 class="mb-0">تفاصيل التكلفة لكل إعلان</h5>
    </div>
    <div class="card-body table-responsive">
        <table class="table table-hover align-middle">
            <thead>
                <tr>
                    <th>الإعلان</th>
                    <th>الظهور</th>
                    <th>النقرات</th>
                    <th>CPM (دولار)</th>
                    <th>CPC (دولار)</th>
                    <th>التكلفة الإجمالية</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var row in Model.BillingRows)
                {
                    <tr>
                        <td>@row.AdName</td>
                        <td>@row.Impressions</td>
                        <td>@row.Clicks</td>
                        <td>@row.CPM.ToString("N2")</td>
                        <td>@row.CPC.ToString("N2")</td>
                        <td><strong>@row.TotalCost.ToString("N2") دولار</strong></td>
                    </tr>
                }
            </tbody>
            <tfoot>
                <tr class="table-secondary">
                    <th colspan="5" class="text-end">الإجمالي:</th>
                    <th><strong>@Model.EstimatedSpend.ToString("N2") دولار</strong></th>
                </tr>
            </tfoot>
        </table>
    </div>
</div>

<!-- Charts Row -->
<div class="row g-4 mb-4">
    <!-- Ads Status Distribution -->
    <div class="col-xl-4 col-lg-6">
        <div class="chart-container">
            <div class="chart-header">
                <div>
                    <h5 class="chart-title">حالة الإعلانات</h5>
                    <p class="chart-subtitle">التوزيع حسب الحالة</p>
                </div>
            </div>
            <div style="position: relative; height: 250px;">
                <canvas id="adsStatusChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Impressions vs Clicks -->
    <div class="col-xl-8 col-lg-6">
        <div class="chart-container">
            <div class="chart-header">
                <div>
                    <h5 class="chart-title">أداء الإعلانات</h5>
                    <p class="chart-subtitle">المشاهدات والنقرات</p>
                </div>
            </div>
            <div style="position: relative; height: 250px;">
                <canvas id="performanceChart"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Engagement & Conversion Analysis -->
<div class="row g-4 mb-4">
    <div class="col-xl-6">
        <div class="chart-container">
            <div class="chart-header">
                <div>
                    <h5 class="chart-title">تحليل التفاعل</h5>
                    <p class="chart-subtitle">نسبة التفاعل مع الإعلانات</p>
                </div>
            </div>
            <div style="position: relative; height: 300px;">
                <canvas id="engagementChart"></canvas>
            </div>
        </div>
    </div>

    <div class="col-xl-6">
        <div class="chart-container">
            <div class="chart-header">
                <div>
                    <h5 class="chart-title">نظرة شاملة على الأداء</h5>
                    <p class="chart-subtitle">جميع المقاييس الرئيسية</p>
                </div>
            </div>
            <div style="position: relative; height: 300px;">
                <canvas id="overviewChart"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions & Campaign Summary -->
<div class="row g-4">
    <!-- Quick Actions -->
    <div class="col-xl-4 col-lg-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">إجراءات سريعة</h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a asp-controller="AdvertiserAds" asp-action="Create" class="btn btn-primary">
                        <i class="bi bi-plus-circle"></i>
                        إنشاء إعلان جديد
                    </a>
                    <a asp-controller="AdvertiserAds" asp-action="Index" class="btn btn-outline-primary">
                        <i class="bi bi-megaphone"></i>
                        عرض جميع الإعلانات
                    </a>
                    @if (Model.PendingAds > 0)
                    {
                        <div class="alert alert-warning mb-0">
                            <i class="bi bi-info-circle"></i>
                            لديك <strong>@Model.PendingAds</strong> إعلان بانتظار موافقة المسؤول
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- Campaign Performance -->
    <div class="col-xl-4 col-lg-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">أداء الحملة</h5>
            </div>
            <div class="card-body">
                <div class="mb-3 pb-3 border-bottom">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="text-secondary">معدل الموافقة على الإعلانات</span>
                        <strong class="text-success">
                            @if (Model.TotalAds > 0)
                            {
                                @Math.Round((double)Model.ApprovedAds / Model.TotalAds * 100, 1)
                            
                                <text>%</text>
                            }
                            else
                            {
                                <text>0%</text>
                            }
                        </strong>
                    </div>
                    <div class="progress" style="height: 8px;">
                        <div class="progress-bar bg-success" role="progressbar"
                             style="width: @(Model.TotalAds > 0 ? Math.Round((double)Model.ApprovedAds / Model.TotalAds * 100, 1) : 0)%"></div>
                    </div>
                </div>

                <div class="mb-3 pb-3 border-bottom">
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="text-secondary">إجمالي التفاعل</span>
                        <strong>@((Model.TotalImpressions + Model.TotalClicks).ToString("N0"))</strong>
                    </div>
                </div>

                <div>
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="text-secondary">متوسط النقرات لكل إعلان</span>
                        <strong>
                            @if (Model.TotalAds > 0)
                            {
                                @Math.Round((double)Model.TotalClicks / Model.TotalAds, 0).ToString("N0")
                            }
                            else
                            {
                                <text>0</text>
                            }
                        </strong>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Performance Insights -->
    <div class="col-xl-4 col-lg-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">رؤى الأداء</h5>
            </div>
            <div class="card-body">
                <div class="d-flex align-items-start gap-3 mb-3 pb-3 border-bottom">
                    <div class="stat-card-icon primary" style="width: 40px; height: 40px; font-size: 18px;">
                        <i class="bi bi-trophy"></i>
                    </div>
                    <div>
                        <div class="text-secondary small">أفضل معدل نقر</div>
                        <strong>
                            @if (Model.TotalImpressions > 0)
                            {
                                @(Math.Round((double)Model.TotalClicks / Model.TotalImpressions * 100, 2))
                            
                                <text>%</text>
                            }
                            else
                            {
                                <text>0%</text>
                            }
                        </strong>
                    </div>
                </div>

                <div class="d-flex align-items-start gap-3 mb-3 pb-3 border-bottom">
                    <div class="stat-card-icon success" style="width: 40px; height: 40px; font-size: 18px;">
                        <i class="bi bi-eye-fill"></i>
                    </div>
                    <div>
                        <div class="text-secondary small">الوصول الإجمالي</div>
                        <strong>@Model.TotalImpressions.ToString("N0")</strong>
                    </div>
                </div>

                <div class="d-flex align-items-start gap-3">
                    <div class="stat-card-icon warning" style="width: 40px; height: 40px; font-size: 18px;">
                        <i class="bi bi-lightning-fill"></i>
                    </div>
                    <div>
                        <div class="text-secondary small">التفاعل النشط</div>
                        <strong>@Model.ApprovedAds من @Model.TotalAds</strong>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Ads Status Chart (Pie)
        const adsStatusCtx = document.getElementById('adsStatusChart');
        new Chart(adsStatusCtx, {
            type: 'pie',
            data: {
                labels: ['مفعل', 'بانتظار الموافقة'],
                datasets: [{
                    data: [@Model.ApprovedAds, @Model.PendingAds],
                    backgroundColor: [
                        'rgba(0, 171, 85, 0.8)',
                        'rgba(255, 171, 0, 0.8)'
                    ],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 15
                        }
                    }
                }
            }
        });

        // Performance Chart (Bar - Impressions vs Clicks)
        const performanceCtx = document.getElementById('performanceChart');
        new Chart(performanceCtx, {
            type: 'bar',
            data: {
                labels: ['المشاهدات', 'النقرات'],
                datasets: [{
                    label: 'العدد',
                    data: [@Model.TotalImpressions, @Model.TotalClicks],
                    backgroundColor: [
                        'rgba(255, 86, 48, 0.8)',
                        'rgba(0, 184, 217, 0.8)'
                    ],
                    borderRadius: 8,
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(145, 158, 171, 0.08)'
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        }
                    }
                }
            }
        });

        // Engagement Chart (Doughnut)
        const engagementCtx = document.getElementById('engagementChart');
        const ctr = @(Model.TotalImpressions > 0 ? Math.Round((double)Model.TotalClicks / Model.TotalImpressions * 100, 2) : 0);
        const nonEngagement = 100 - ctr;

        new Chart(engagementCtx, {
            type: 'doughnut',
            data: {
                labels: ['معدل النقر', 'بدون تفاعل'],
                datasets: [{
                    data: [ctr, nonEngagement],
                    backgroundColor: [
                        'rgba(0, 171, 85, 0.8)',
                        'rgba(196, 205, 213, 0.3)'
                    ],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 15
                        }
                    }
                },
                cutout: '70%'
            }
        });

        // Overview Chart (Radar)
        const overviewCtx = document.getElementById('overviewChart');
        const avgImpressions = @(Model.TotalAds > 0 ? Math.Round((double)Model.TotalImpressions / Model.TotalAds, 0) : 0);
        const avgClicks = @(Model.TotalAds > 0 ? Math.Round((double)Model.TotalClicks / Model.TotalAds, 0) : 0);
        const approvalRate = @(Model.TotalAds > 0 ? Math.Round((double)Model.ApprovedAds / Model.TotalAds * 100, 1) : 0);

        new Chart(overviewCtx, {
            type: 'radar',
            data: {
                labels: ['إجمالي الإعلانات', 'الإعلانات المفعلة', 'معدل الموافقة %', 'متوسط المشاهدات', 'متوسط النقرات', 'معدل النقر %'],
                datasets: [{
                    label: 'الأداء',
                    data: [
                        @Model.TotalAds,
                        @Model.ApprovedAds,
                        approvalRate,
                        avgImpressions / 10, // Scaled for better visualization
                        avgClicks,
                        ctr * 10 // Scaled up for visibility
                    ],
                    backgroundColor: 'rgba(32, 101, 209, 0.2)',
                    borderColor: 'rgba(32, 101, 209, 0.8)',
                    borderWidth: 2,
                    pointBackgroundColor: 'rgba(32, 101, 209, 1)',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2,
                    pointRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    r: {
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(145, 158, 171, 0.08)'
                        },
                        angleLines: {
                            color: 'rgba(145, 158, 171, 0.08)'
                        },
                        pointLabels: {
                            font: {
                                size: 11
                            }
                        }
                    }
                }
            }
        });
    </script>
}