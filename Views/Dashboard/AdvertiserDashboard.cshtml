@* @model IEnumerable<AdSystem.Models.Ad>
@{
    ViewData["Title"] = "Advertiser Dashboard";
}

<h2>📢 Advertiser Dashboard</h2>

<div class="row text-center mt-3">
    <div class="col-md-4">
        <div class="card">
            <div class="card-body">
                <h4>Total Ads</h4><h2>@ViewBag.TotalAds</h2>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card">
            <div class="card-body">
                <h4>Total Clicks</h4><h2>@ViewBag.TotalClicks</h2>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card">
            <div class="card-body">
                <h4>Total Impressions</h4><h2>@ViewBag.TotalImpressions</h2>
            </div>
        </div>
    </div>
</div> *@

@* <h4 class="mt-5">My Ads</h4>
<table class="table table-bordered mt-3">
    <thead>
        <tr>
            <th>Title</th>
            <th>Clicks</th>
            <th>Impressions</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var ad in Model)
        {
            <tr>
                <td>@ad.Title</td>
                <td>@ad.Clicks</td>
                <td>@ad.Impressions</td>
            </tr>
        } *@
    @* </tbody> *@
@* </table> *@ 
@* @model IEnumerable<AdSystem.Models.Ad> *@
@* @{
    ViewData["Title"] = "لوحة المعلن";
} *@

@* <div class="container mt-5">
    <h1 class="text-center mb-4">📢 لوحة تحكم المعلن</h1>

    <!-- Summary cards -->
    <div class="row g-4 text-center">
        <div class="col-md-4">
            <div class="card bg-primary text-white shadow-sm">
                <div class="card-body">
                    <h5>عدد الإعلانات</h5>
                    <h3>@ViewBag.TotalAds</h3>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card bg-success text-white shadow-sm">
                <div class="card-body">
                    <h5>إجمالي النقرات</h5>
                    <h3>@ViewBag.TotalClicks</h3>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card bg-warning text-dark shadow-sm">
                <div class="card-body">
                    <h5>عدد مرات الظهور</h5>
                    <h3>@ViewBag.TotalImpressions</h3>
                </div>
            </div>
        </div>
    </div> *@

    <!-- Chart Section -->
    @* <div class="mt-5">
        <h4 class="mb-3 text-center">📈 أداء الإعلانات</h4>
        <div class="card shadow-sm">
            <div class="card-body">
                <canvas id="adsChart" height="100"></canvas>
            </div>
        </div>
    </div> *@

    <!-- Ads Table -->
@*     <div class="mt-5">
        <h4 class="mb-3 text-center">قائمة الإعلانات</h4>

        @if (!Model.Any())
        {
            <div class="alert alert-info text-center">
                لا توجد إعلانات حالياً. يمكنك إضافة إعلان جديد.
            </div>
        }
        else
        {
            <table class="table table-striped table-bordered text-center align-middle">
                <thead class="table-dark">
                    <tr>
                        <th>العنوان</th>
                        <th>النقرات</th>
                        <th>الظهور</th>
                        <th>تاريخ الإنشاء</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var ad in Model)
                    {
                        <tr>
                            <td>@ad.Title</td>
                            <td>@ad.Clicks</td>
                            <td>@ad.Impressions</td>
                            <td>@ad.CreatedAt.ToShortDateString()</td>
                        </tr>
                    }
                </tbody>
            </table>
        }
    </div>
</div>
*@

@* @section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", async () => {
            try {
                const response = await fetch('/Analytics/GetAdvertiserAdStats');
                const data = await response.json();

                const ctx = document.getElementById('adsChart').getContext('2d');
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.map(x => x.date),
                        datasets: [
                            {
                                label: 'Clicks',
                                data: data.map(x => x.clicks),
                                borderColor: '#28a745',
                                backgroundColor: 'rgba(40,167,69,0.1)',
                                tension: 0.3,
                                fill: true
                            },
                            {
                                label: 'Impressions',
                                data: data.map(x => x.impressions),
                                borderColor: '#ffc107',
                                backgroundColor: 'rgba(255,193,7,0.1)',
                                tension: 0.3,
                                fill: true
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { position: 'bottom' },
                            title: {
                                display: true,
                                text: 'تحليل أداء الإعلانات بمرور الوقت',
                                font: { size: 18 }
                            }
                        },
                        scales: {
                            y: { beginAtZero: true },
                            x: { ticks: { autoSkip: true, maxTicksLimit: 7 } }
                        }
                    }
                });
            } catch (error) {
                console.error('Error loading chart data:', error);
            }
        });
    </script>
} *@

@* } *@

@* @model IEnumerable<AdSystem.Models.Ad>

@{
    ViewData["Title"] = "Advertiser Dashboard";
    // ViewBag.TotalAds, ViewBag.TotalClicks, ViewBag.TotalImpressions must be set by the controller.
}

<div class="container mt-4">

    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="fw-bold">📊 Advertiser Dashboard</h2>
        <div>
            <a asp-controller="Ads" asp-action="Create" class="btn btn-primary">+ New Ad</a>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="row g-3 mb-4">
        <div class="col-md-3">
            <div class="card shadow-sm">
                <div class="card-body text-center">
                    <h6 class="card-subtitle mb-2 text-muted">Total Ads</h6>
                    <h3 class="card-title">@((ViewBag.TotalAds ?? 0).ToString())</h3>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card shadow-sm">
                <div class="card-body text-center">
                    <h6 class="card-subtitle mb-2 text-muted">Total Clicks</h6>
                    <h3 class="card-title">@((ViewBag.TotalClicks ?? 0).ToString())</h3>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card shadow-sm">
                <div class="card-body text-center">
                    <h6 class="card-subtitle mb-2 text-muted">Total Impressions</h6>
                    <h3 class="card-title">@((ViewBag.TotalImpressions ?? 0).ToString())</h3>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card shadow-sm">
                <div class="card-body text-center">
                    <h6 class="card-subtitle mb-2 text-muted">CTR</h6>
                    @{
                        var clicks = (int?)ViewBag.TotalClicks ?? 0;
                        var impressions = (int?)ViewBag.TotalImpressions ?? 0;
                        var ctr = impressions > 0 ? Math.Round((double)clicks / impressions * 100, 2) : 0;
                    }
                    <h3 class="card-title">@ctr %</h3>
                </div>
            </div>
        </div>
    </div>

    <!-- Chart + Filters -->
    <div class="card mb-4 shadow-sm">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0">Performance (Clicks & Impressions)</h5>

                <div class="d-flex gap-2 align-items-center">
                    <input id="fromDate" type="date" class="form-control form-control-sm" />
                    <input id="toDate" type="date" class="form-control form-control-sm" />
                    <button id="filterBtn" class="btn btn-sm btn-primary">Filter</button>
                    <button id="resetBtn" class="btn btn-sm btn-outline-secondary">Reset</button>
                </div>
            </div>

            <canvas id="advertiserChart" height="110"></canvas>
            <div id="chartError" class="text-danger mt-2" style="display:none;"></div>
        </div>
    </div>

    <!-- Ads Table -->
    <div class="card shadow-sm">
        <div class="card-body">
            <h5 class="card-title">My Ads</h5>
            <p class="text-muted">Manage your ads — edit, view details or delete.</p>

            <div class="table-responsive">
                <table class="table table-striped table-bordered align-middle">
                    <thead class="table-dark">
                        <tr>
                            <th>Title</th>
                            <th>Preview</th>
                            <th>Target URL</th>
                            <th>Website</th>
                            <th>Impressions</th>
                            <th>Clicks</th>
                            <th>Active</th>
                            <th style="width:160px">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (Model != null && Model.Any())
                        {
                            foreach (var ad in Model)
                            {
                                <tr>
                                    <td>@ad.Title</td>
                                    <td>
                                        @if (!string.IsNullOrEmpty(ad.ImageUrl))
                                        {
                                            <img src="@ad.ImageUrl" alt="@ad.Title" style="max-width:120px; max-height:60px;" />
                                        }
                                        else
                                        {
                                            <span class="text-muted">No image</span>
                                        }
                                    </td>
                                    <td>
                                        @if (!string.IsNullOrEmpty(ad.TargetUrl))
                                        {
                                            <a href="@ad.TargetUrl" target="_blank">@ad.TargetUrl</a>
                                        }
                                    </td>
                                    <td>@ad.Website?.Name</td>
                                    <td>@ad.Impressions</td>
                                    <td>@ad.Clicks</td>
                                    <td>@(ad.IsActive ? "Yes" : "No")</td>
                                    <td>
                                        <a class="btn btn-sm btn-outline-primary" asp-controller="Ads" asp-action="Edit" asp-route-id="@ad.Id">Edit</a>
                                        <a class="btn btn-sm btn-outline-info" asp-controller="Ads" asp-action="Details" asp-route-id="@ad.Id">Details</a>
                                        <form asp-controller="Ads" asp-action="Delete" asp-route-id="@ad.Id" method="post" class="d-inline" onsubmit="return confirm('Delete this ad?');">
                                            <button type="submit" class="btn btn-sm btn-danger">Delete</button>
                                        </form>
                                    </td>
                                </tr>
                            }
                        }
                        else
                        {
                            <tr>
                                <td colspan="8" class="text-center text-muted">You have no ads yet. Create one to get started.</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>

</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        (function () {
            let advertiserChart;

            function showError(msg) {
                const el = document.getElementById('chartError');
                el.style.display = 'block';
                el.textContent = msg;
            }

            function clearError() {
                const el = document.getElementById('chartError');
                el.style.display = 'none';
                el.textContent = '';
            }

            async function loadAdStats() {
                clearError();

                const from = document.getElementById('fromDate').value;
                const to = document.getElementById('toDate').value;
                const qs = (from && to) ? `?from=${encodeURIComponent(from)}&to=${encodeURIComponent(to)}` : '';
                const url = '/Analytics/GetAdvertiserAdStats' + qs;

                try {
                    const res = await fetch(url, { credentials: 'same-origin' });
                    if (!res.ok) {
                        const text = await res.text();
                        showError('Analytics API error: ' + res.status + ' — ' + text);
                        return;
                    }

                    const data = await res.json();

                    // format for Chart.js
                    const labels = data.map(d => d.date);
                    const clicks = data.map(d => d.totalClicks);
                    const impressions = data.map(d => d.totalImpressions);

                    renderChart(labels, clicks, impressions);
                } catch (err) {
                    console.error(err);
                    showError('Failed to load analytics. See console for details.');
                }
            }

            function renderChart(labels, clicks, impressions) {
                const ctx = document.getElementById('advertiserChart').getContext('2d');

                if (advertiserChart) advertiserChart.destroy();

                advertiserChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Clicks',
                                data: clicks,
                                borderColor: '#007bff',
                                backgroundColor: 'rgba(0,123,255,0.08)',
                                tension: 0.3,
                                fill: true,
                            },
                            {
                                label: 'Impressions',
                                data: impressions,
                                borderColor: '#28a745',
                                backgroundColor: 'rgba(40,167,69,0.08)',
                                tension: 0.3,
                                fill: true,
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { position: 'bottom' }
                        },
                        scales: {
                            y: { beginAtZero: true }
                        }
                    }
                });
            }

            // handlers
            document.getElementById('filterBtn').addEventListener('click', function (e) {
                e.preventDefault();
                loadAdStats();
            });
            document.getElementById('resetBtn').addEventListener('click', function (e) {
                e.preventDefault();
                document.getElementById('fromDate').value = '';
                document.getElementById('toDate').value = '';
                loadAdStats();
            });

            // initial load
            document.addEventListener('DOMContentLoaded', function () {
                loadAdStats();
            });
        })();
    </script>
} *@

@model IEnumerable<AdSystem.Models.Ad>

@{
    ViewData["Title"] = "لوحة المعلن";
    // ViewBag.TotalAds, ViewBag.TotalClicks, ViewBag.TotalImpressions must be set by the controller.
}

<!-- Page Header -->
<div class="page-header">
    <div>
        <h1 class="page-title">📊 لوحة المعلن</h1>
        <p class="page-subtitle">إحصائيات الأداء وإدارة الإعلانات</p>
    </div>
    <div class="action-buttons">
        <a asp-controller="Ads" asp-action="Create" class="btn btn-primary">
            <i class="bi bi-plus-circle ms-1"></i>
            إعلان جديد
        </a>
    </div>
</div>

<!-- Summary Stats -->
<div class="row g-3 mb-4">
    <div class="col-12 col-sm-6 col-lg-3">
        <div class="stat-card">
            <div class="stat-icon bg-primary-lighter">
                <i class="bi bi-megaphone" style="color: var(--primary-main);"></i>
            </div>
            <div class="stat-content">
                <div class="stat-label">إجمالي الإعلانات</div>
                <div class="stat-value">@((ViewBag.TotalAds ?? 0).ToString("N0"))</div>
            </div>
        </div>
    </div>

    <div class="col-12 col-sm-6 col-lg-3">
        <div class="stat-card">
            <div class="stat-icon bg-success-lighter">
                <i class="bi bi-cursor" style="color: var(--success-main);"></i>
            </div>
            <div class="stat-content">
                <div class="stat-label">إجمالي النقرات</div>
                <div class="stat-value">@((ViewBag.TotalClicks ?? 0).ToString("N0"))</div>
            </div>
        </div>
    </div>

    <div class="col-12 col-sm-6 col-lg-3">
        <div class="stat-card">
            <div class="stat-icon bg-info-lighter">
                <i class="bi bi-eye" style="color: var(--info-main);"></i>
            </div>
            <div class="stat-content">
                <div class="stat-label">إجمالي المشاهدات</div>
                <div class="stat-value">@((ViewBag.TotalImpressions ?? 0).ToString("N0"))</div>
            </div>
        </div>
    </div>

    <div class="col-12 col-sm-6 col-lg-3">
        <div class="stat-card">
            <div class="stat-icon bg-warning-lighter">
                <i class="bi bi-graph-up-arrow" style="color: var(--warning-main);"></i>
            </div>
            <div class="stat-content">
                <div class="stat-label">نسبة النقر (CTR)</div>
                @{
                    var clicks = (int?)ViewBag.TotalClicks ?? 0;
                    var impressions = (int?)ViewBag.TotalImpressions ?? 0;
                    var ctr = impressions > 0 ? Math.Round((double)clicks / impressions * 100, 2) : 0;
                }
                <div class="stat-value">@ctr%</div>
            </div>
        </div>
    </div>
</div>

<!-- Performance Chart -->
<div class="chart-container mb-4">
    <div class="chart-header">
        <div>
            <h5 class="chart-title">أداء الإعلانات</h5>
            <p class="chart-subtitle">النقرات والمشاهدات على مدار الوقت</p>
        </div>
        <div class="d-flex gap-2 align-items-center flex-wrap">
            <input id="fromDate" type="date" class="form-control form-control-sm" style="max-width: 160px;" placeholder="من تاريخ" />
            <input id="toDate" type="date" class="form-control form-control-sm" style="max-width: 160px;" placeholder="إلى تاريخ" />
            <button id="filterBtn" class="btn btn-sm btn-primary">
                <i class="bi bi-funnel ms-1"></i>
                تصفية
            </button>
            <button id="resetBtn" class="btn btn-sm btn-outline-secondary">
                <i class="bi bi-arrow-clockwise ms-1"></i>
                إعادة تعيين
            </button>
        </div>
    </div>
    <div class="chart-body">
        <canvas id="advertiserChart" height="90"></canvas>
        <div id="chartError" class="alert alert-danger mt-3" style="display:none;">
            <i class="bi bi-exclamation-triangle ms-2"></i>
            <span id="chartErrorText"></span>
        </div>
    </div>
</div>

<!-- Ads Table -->
<div class="card">
    <div class="card-header">
        <h5 class="card-title mb-1">إعلاناتي</h5>
        <p class="card-subtitle text-muted mb-0">إدارة جميع إعلاناتك - تحرير، عرض التفاصيل أو حذف</p>
    </div>
    <div class="card-body p-0">
        @if (Model != null && Model.Any())
        {
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead>
                        <tr>
                            <th class="ps-4">العنوان</th>
                            <th>المعاينة</th>
                            <th>رابط الهدف</th>
                            @* <th>الموقع</th> *@
                            <th class="text-center">المشاهدات</th>
                            <th class="text-center">النقرات</th>
                            <th class="text-center">الحالة</th>
                            <th class="text-center pe-4">الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var ad in Model)
                        {
                            <tr>
                                <td class="ps-4">
                                    <div class="fw-semibold" style="color: var(--text-primary);">@ad.Title</div>
                                </td>
                                <td>
                                    @if (!string.IsNullOrEmpty(ad.ImageUrl))
                                    {
                                        <img src="@ad.ImageUrl" alt="@ad.Title"
                                             style="max-width:100px; max-height:60px; border-radius: var(--radius-sm); object-fit: cover;"
                                             class="shadow-sm" />
                                    }
                                    else
                                    {
                                        <div class="d-flex align-items-center justify-content-center bg-light rounded"
                                             style="width:100px; height:60px; border-radius: var(--radius-sm);">
                                            <i class="bi bi-image text-muted"></i>
                                        </div>
                                    }
                                </td>
                                <td>
                                    @if (!string.IsNullOrEmpty(ad.TargetUrl))
                                    {
                                        <a href="@ad.TargetUrl" target="_blank" class="text-decoration-none"
                                           style="color: var(--primary-main); max-width: 200px; display: inline-block; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                            <i class="bi bi-box-arrow-up-left ms-1" style="font-size: 0.875rem;"></i>
                                            @ad.TargetUrl
                                        </a>
                                    }
                                    else
                                    {
                                        <span class="text-muted">—</span>
                                    }
                                </td>
                                @* <td>
                                    @if (ad.Website != null)
                                    {
                                        <span class="badge bg-light text-dark px-3 py-2">@ad.Website.Name</span>
                                    }
                                    else
                                    {
                                        <span class="text-muted">—</span>
                                    }
                                </td> *@
                                @* <td class="text-center">
                                    <span class="fw-semibold" style="color: var(--text-primary);">@ad.Impressions.ToString("N0")</span>
                                </td>
                                <td class="text-center">
                                    <span class="fw-semibold" style="color: var(--success-main);">@ad.Clicks.ToString("N0")</span>
                                </td>
                                <td class="text-center">
                                    @if (ad.IsActive)
                                    {
                                        <span class="status-dot status-active">نشط</span>
                                    }
                                    else
                                    {
                                        <span class="status-dot status-inactive">غير نشط</span>
                                    }
                                </td> *@
                                <td class="text-center pe-4">
                                    <div class="btn-group" role="group">
                                        <a class="btn btn-sm btn-icon btn-outline-primary"
                                           asp-controller="Ads" asp-action="Edit" asp-route-id="@ad.Id"
                                           title="تحرير">
                                            <i class="bi bi-pencil"></i>
                                        </a>
                                        <a class="btn btn-sm btn-icon btn-outline-info"
                                           asp-controller="Ads" asp-action="Details" asp-route-id="@ad.Id"
                                           title="التفاصيل">
                                            <i class="bi bi-eye"></i>
                                        </a>
                                        <form asp-controller="Ads" asp-action="Delete" asp-route-id="@ad.Id"
                                              method="post" class="d-inline"
                                              onsubmit="return confirm('هل أنت متأكد من حذف هذا الإعلان؟');">
                                            <button type="submit" class="btn btn-sm btn-icon btn-outline-danger" title="حذف">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </form>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
        else
        {
            <div class="empty-state">
                <div class="empty-icon">
                    <i class="bi bi-megaphone"></i>
                </div>
                <h5 class="empty-title">لا توجد إعلانات بعد</h5>
                <p class="empty-text">ابدأ بإنشاء إعلانك الأول للوصول إلى جمهورك المستهدف</p>
                <a asp-controller="Ads" asp-action="Create" class="btn btn-primary mt-2">
                    <i class="bi bi-plus-circle ms-1"></i>
                    إنشاء إعلان جديد
                </a>
            </div>
        }
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        (function () {
            let advertiserChart;

            // Chart colors from Minimal Dashboard theme
            const chartColors = {
                primary: '#2065D1',
                success: '#00AB55',
                warning: '#FFAB00',
                error: '#FF5630',
                info: '#00B8D9',
                primaryLight: 'rgba(32, 101, 209, 0.08)',
                successLight: 'rgba(0, 171, 85, 0.08)'
            };

            function showError(msg) {
                const errorDiv = document.getElementById('chartError');
                const errorText = document.getElementById('chartErrorText');
                errorDiv.style.display = 'block';
                errorText.textContent = msg;
            }

            function clearError() {
                const errorDiv = document.getElementById('chartError');
                errorDiv.style.display = 'none';
            }

            async function loadAdStats() {
                clearError();

                const from = document.getElementById('fromDate').value;
                const to = document.getElementById('toDate').value;
                const qs = (from && to) ? `?from=${encodeURIComponent(from)}&to=${encodeURIComponent(to)}` : '';
                const url = '/Analytics/GetAdvertiserAdStats' + qs;

                try {
                    const res = await fetch(url, { credentials: 'same-origin' });
                    if (!res.ok) {
                        const text = await res.text();
                        showError('خطأ في تحميل البيانات: ' + res.status + ' — ' + text);
                        return;
                    }

                    const data = await res.json();

                    // Format for Chart.js
                    const labels = data.map(d => d.date);
                    const clicks = data.map(d => d.totalClicks);
                    const impressions = data.map(d => d.totalImpressions);

                    renderChart(labels, clicks, impressions);
                } catch (err) {
                    console.error(err);
                    showError('فشل تحميل التحليلات. راجع وحدة التحكم للحصول على التفاصيل.');
                }
            }

            function renderChart(labels, clicks, impressions) {
                const ctx = document.getElementById('advertiserChart').getContext('2d');

                if (advertiserChart) advertiserChart.destroy();

                advertiserChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'النقرات',
                                data: clicks,
                                borderColor: chartColors.success,
                                backgroundColor: chartColors.successLight,
                                tension: 0.4,
                                fill: true,
                                borderWidth: 2,
                                pointRadius: 4,
                                pointHoverRadius: 6,
                                pointBackgroundColor: '#fff',
                                pointBorderColor: chartColors.success,
                                pointBorderWidth: 2
                            },
                            {
                                label: 'المشاهدات',
                                data: impressions,
                                borderColor: chartColors.primary,
                                backgroundColor: chartColors.primaryLight,
                                tension: 0.4,
                                fill: true,
                                borderWidth: 2,
                                pointRadius: 4,
                                pointHoverRadius: 6,
                                pointBackgroundColor: '#fff',
                                pointBorderColor: chartColors.primary,
                                pointBorderWidth: 2
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        interaction: {
                            mode: 'index',
                            intersect: false
                        },
                        plugins: {
                            legend: {
                                position: 'bottom',
                                rtl: true,
                                labels: {
                                    usePointStyle: true,
                                    padding: 16,
                                    font: {
                                        family: 'Cairo, sans-serif',
                                        size: 13
                                    }
                                }
                            },
                            tooltip: {
                                rtl: true,
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                padding: 12,
                                cornerRadius: 8,
                                titleFont: {
                                    family: 'Cairo, sans-serif',
                                    size: 13,
                                    weight: '600'
                                },
                                bodyFont: {
                                    family: 'Cairo, sans-serif',
                                    size: 12
                                },
                                callbacks: {
                                    label: function(context) {
                                        let label = context.dataset.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        label += context.parsed.y.toLocaleString('ar-EG');
                                        return label;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                grid: {
                                    display: false
                                },
                                ticks: {
                                    font: {
                                        family: 'Cairo, sans-serif',
                                        size: 11
                                    }
                                }
                            },
                            y: {
                                beginAtZero: true,
                                grid: {
                                    color: 'rgba(145, 158, 171, 0.08)',
                                    drawBorder: false
                                },
                                ticks: {
                                    font: {
                                        family: 'Cairo, sans-serif',
                                        size: 11
                                    },
                                    callback: function(value) {
                                        return value.toLocaleString('ar-EG');
                                    }
                                }
                            }
                        }
                    }
                });
            }

            // Event handlers
            document.getElementById('filterBtn').addEventListener('click', function (e) {
                e.preventDefault();
                const from = document.getElementById('fromDate').value;
                const to = document.getElementById('toDate').value;

                if (from && to && from > to) {
                    showError('تاريخ البداية يجب أن يكون قبل تاريخ النهاية');
                    return;
                }

                loadAdStats();
            });

            document.getElementById('resetBtn').addEventListener('click', function (e) {
                e.preventDefault();
                document.getElementById('fromDate').value = '';
                document.getElementById('toDate').value = '';
                loadAdStats();
            });

            // Initial load
            document.addEventListener('DOMContentLoaded', function () {
                loadAdStats();
            });
        })();
    </script>
}
