@* @model IEnumerable<AdSystem.Models.Ad>
@{
    ViewData["Title"] = "Publisher Dashboard";
}

<h2>📰 Publisher Dashboard</h2>

<div class="row text-center mt-3">
    <div class="col-md-4">
        <div class="card">
            <div class="card-body">
                <h4>Total Ads</h4><h2>@ViewBag.TotalAds</h2>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card">
            <div class="card-body">
                <h4>Total Clicks</h4><h2>@ViewBag.TotalClicks</h2>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card">
            <div class="card-body">
                <h4>Total Impressions</h4><h2>@ViewBag.TotalImpressions</h2>
            </div>
        </div>
    </div>
</div>

<h4 class="mt-5">Assigned Ads</h4>
<table class="table table-bordered mt-3">
    <thead>
        <tr>
            <th>Title</th>
            <th>Clicks</th>
            <th>Impressions</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var ad in Model)
        {
            <tr>
                <td>@ad.Title</td>
                <td>@ad.Clicks</td>
                <td>@ad.Impressions</td>
            </tr>
        }
    </tbody>
</table>
@model IEnumerable<AdSystem.Models.Website>
@{
    ViewData["Title"] = "لوحة الناشر";
}

<div class="container mt-5">
    <h1 class="text-center mb-4">📰 لوحة تحكم الناشر</h1>

    <!-- Summary cards -->
    <div class="row g-4 text-center">
        <div class="col-md-4">
            <div class="card bg-primary text-white shadow-sm">
                <div class="card-body">
                    <h5>عدد المواقع</h5>
                    <h3>@ViewBag.TotalWebsites</h3>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card bg-success text-white shadow-sm">
                <div class="card-body">
                    <h5>إجمالي النقرات على الإعلانات</h5>
                    <h3>@ViewBag.TotalClicks</h3>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card bg-warning text-dark shadow-sm">
                <div class="card-body">
                    <h5>عدد مرات الظهور</h5>
                    <h3>@ViewBag.TotalImpressions</h3>
                </div>
            </div>
        </div>
    </div>

    <!-- Chart Section -->
    <div class="mt-5">
        <h4 class="mb-3 text-center">📊 أداء المواقع</h4>
        <div class="card shadow-sm">
            <div class="card-body">
                <canvas id="publisherChart" height="100"></canvas>
            </div>
        </div>
    </div>

    <!-- Websites Table -->
    <div class="mt-5">
        <h4 class="mb-3 text-center">قائمة المواقع</h4>

        @if (!Model.Any())
        {
            <div class="alert alert-info text-center">
                لا توجد مواقع حالياً. يمكنك إضافة موقع جديد لعرض الإعلانات.
            </div>
        }
        else
        {
            <table class="table table-striped table-bordered text-center align-middle">
                <thead class="table-dark">
                    <tr>
                        <th>اسم الموقع</th>
                        <th>الرابط</th>
                        <th>النقرات</th>
                        <th>الظهور</th>
                        <th>تاريخ الإضافة</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var site in Model)
                    {
                        <tr>
                            <td>@site.Name</td>
                            <td>
                                <a href="@site.Url" target="_blank">@site.Url</a>
                            </td>
                            <td>@site.TotalClicks</td>
                            <td>@site.TotalImpressions</td>
                            <td>@site.CreatedAt.ToShortDateString()</td>
                        </tr>
                    }
                </tbody>
            </table>
        }
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", async () => {
            try {
                const response = await fetch('/Analytics/GetPublisherSiteStats');
                const data = await response.json();

                const ctx = document.getElementById('publisherChart').getContext('2d');
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: data.map(x => x.siteName),
                        datasets: [
                            {
                                label: 'Impressions',
                                data: data.map(x => x.impressions),
                                backgroundColor: 'rgba(255,193,7,0.6)',
                                borderColor: '#ffc107',
                                borderWidth: 1
                            },
                            {
                                label: 'Clicks',
                                data: data.map(x => x.clicks),
                                backgroundColor: 'rgba(40,167,69,0.6)',
                                borderColor: '#28a745',
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { position: 'bottom' },
                            title: {
                                display: true,
                                text: 'تحليل أداء المواقع المستضيفة للإعلانات',
                                font: { size: 18 }
                            }
                        },
                        scales: {
                            y: { beginAtZero: true }
                        }
                    }
                });
            } catch (error) {
                console.error('Error loading chart data:', error);
            }
        });
    </script>
}
@model IEnumerable<AdSystem.ViewModels.PublisherSiteViewModel>
@{
    ViewData["Title"] = "Publisher Dashboard";
    var sites = Model ?? Enumerable.Empty<AdSystem.ViewModels.PublisherSiteViewModel>();
}

<div class="container mt-5">
    <h1 class="text-center mb-4">📰 Publisher Dashboard</h1>

    <!-- Summary cards -->
    <div class="row g-4 text-center">
        <div class="col-md-4">
            <div class="card bg-primary text-white shadow-sm">
                <div class="card-body">
                    <h5>Sites</h5>
                    <h3>@ViewBag.TotalWebsites</h3>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card bg-success text-white shadow-sm">
                <div class="card-body">
                    <h5>Total Clicks</h5>
                    <h3>@ViewBag.TotalClicks</h3>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card bg-warning text-dark shadow-sm">
                <div class="card-body">
                    <h5>Impressions</h5>
                    <h3>@ViewBag.TotalImpressions</h3>
                </div>
            </div>
        </div>
    </div>

    <!-- Chart Section -->
    <div class="mt-5">
        <h4 class="mb-3 text-center">📊 Site Performance</h4>
        <div class="card shadow-sm">
            <div class="card-body">
                <canvas id="publisherChart" height="100"></canvas>
            </div>
        </div>
    </div>

    <!-- Sites Table -->
    <div class="mt-5">
        <h4 class="mb-3 text-center">Sites</h4>

        @if (!sites.Any())
        {
            <div class="alert alert-info text-center">
                You have no sites yet. Add a site to start showing ads.
            </div>
        }
        else
        {
            <table class="table table-striped table-bordered text-center align-middle">
                <thead class="table-dark">
                    <tr>
                        <th>Site Name</th>
                        <th>URL</th>
                        <th>Ads</th>
                        <th>Clicks</th>
                        <th>Impressions</th>
                        <th>Created</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var site in sites)
                    {
                        <tr>
                            <td>@site.Name</td>
                            <td>
                                @if (!string.IsNullOrEmpty(site.Url))
                                {
                                    <a href="@site.Url" target="_blank">@site.Url</a>
                                }
                                else
                                {
                                    <span class="text-muted">—</span>
                                }
                            </td>
                            <td>@site.AdsCount</td>
                            <td>@site.TotalClicks</td>
                            <td>@site.TotalImpressions</td>
                            <td>@site.CreatedAt.ToString("yyyy-MM-dd")</td>
                        </tr>
                    }
                </tbody>
            </table>
        }
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", async () => {
            try {
                // Build a simple chart from the server model passed to the view
                const sites = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.Select(s => new {
                    site = s.Name,
                    clicks = s.TotalClicks,
                    impressions = s.TotalImpressions
                })));

                const ctx = document.getElementById('publisherChart').getContext('2d');
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: sites.map(s => s.site),
                        datasets: [
                            {
                                label: 'Impressions',
                                data: sites.map(s => s.impressions),
                                backgroundColor: 'rgba(255,193,7,0.6)'
                            },
                            {
                                label: 'Clicks',
                                data: sites.map(s => s.clicks),
                                backgroundColor: 'rgba(40,167,69,0.6)'
                            }
                        ]
                    },
                    options: { responsive: true, plugins: { legend: { position: 'bottom' } }, scales: { y: { beginAtZero: true } } }
                });
            } catch (err) {
                console.error('Chart error', err);
            }
        });
    </script>
}
 *@
@* @{
    ViewData["Title"] = "لوحة الناشر (المواقع)";
}

<div class="container mt-5">
    <h2 class="mb-4 text-center fw-bold">🌐 إحصائيات الناشر</h2>

    <div class="card shadow-sm border-0 p-4">
        <h5 class="mb-3 fw-semibold">أداء المواقع</h5>
        <canvas id="siteChart" height="120"></canvas>
    </div>
</div>

@section Scripts {
    <script>
        let siteChart;

        async function loadSiteStats() {
            const res = await fetch('/Analytics/GetPublisherSiteStats');
            const data = await res.json();

            const labels = data.map(d => d.websiteName || d.WebsiteName);
            const clicks = data.map(d => d.totalClicks || d.TotalClicks);
            const impressions = data.map(d => d.totalImpressions || d.TotalImpressions);

            renderSiteChart(labels, clicks, impressions);
        }

        function renderSiteChart(labels, clicks, impressions) {
            const ctx = document.getElementById('siteChart').getContext('2d');

            if (siteChart) siteChart.destroy();

            siteChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels,
                    datasets: [
                        {
                            label: 'النقرات (Clicks)',
                            data: clicks,
                            backgroundColor: 'rgba(0, 123, 255, 0.6)'
                        },
                        {
                            label: 'الظهور (Impressions)',
                            data: impressions,
                            backgroundColor: 'rgba(40, 167, 69, 0.6)'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'top' }
                    },
                    scales: {
                        x: { title: { display: true, text: 'الموقع' } },
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        // Auto-load on page start
        loadSiteStats();
    </script>
} *@

@* @model IEnumerable<AdSystem.Models.Website>

@{
    ViewData["Title"] = "Publisher Dashboard";
}

<div class="container mt-4">

    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="fw-bold">🌐 Publisher Dashboard</h2>
        <div>
            <a asp-controller="Websites" asp-action="Create" class="btn btn-primary">+ Add New Website</a>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="row g-3 mb-4">
        <div class="col-md-3">
            <div class="card shadow-sm text-center">
                <div class="card-body">
                    <h6 class="text-muted mb-2">Total Websites</h6>
                    <h3>@((ViewBag.TotalWebsites ?? 0).ToString())</h3>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card shadow-sm text-center">
                <div class="card-body">
                    <h6 class="text-muted mb-2">Total Clicks</h6>
                    <h3>@((ViewBag.TotalClicks ?? 0).ToString())</h3>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card shadow-sm text-center">
                <div class="card-body">
                    <h6 class="text-muted mb-2">Total Impressions</h6>
                    <h3>@((ViewBag.TotalImpressions ?? 0).ToString())</h3>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card shadow-sm text-center">
                <div class="card-body">
                    <h6 class="text-muted mb-2">CTR</h6>
                    @{
                        var clicks = (int?)ViewBag.TotalClicks ?? 0;
                        var impressions = (int?)ViewBag.TotalImpressions ?? 0;
                        var ctr = impressions > 0 ? Math.Round((double)clicks / impressions * 100, 2) : 0;
                    }
                    <h3>@ctr %</h3>
                </div>
            </div>
        </div>
    </div>

    <!-- Chart Section -->
    <div class="card mb-4 shadow-sm">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0">Performance (Clicks & Impressions)</h5>
                <div class="d-flex gap-2 align-items-center">
                    <input id="fromDate" type="date" class="form-control form-control-sm" />
                    <input id="toDate" type="date" class="form-control form-control-sm" />
                    <button id="filterBtn" class="btn btn-sm btn-primary">Filter</button>
                    <button id="resetBtn" class="btn btn-sm btn-outline-secondary">Reset</button>
                </div>
            </div>

            <canvas id="publisherChart" height="110"></canvas>
            <div id="chartError" class="text-danger mt-2" style="display:none;"></div>
        </div>
    </div>

    <!-- Websites Table -->
    <div class="card shadow-sm">
        <div class="card-body">
            <h5 class="card-title">My Websites</h5>
            <p class="text-muted">Manage your registered websites and monitor performance.</p>

            <div class="table-responsive">
                <table class="table table-striped table-bordered align-middle">
                    <thead class="table-dark">
                        <tr>
                            <th>Name</th>
                            <th>Domain</th>
                            <th>URL</th>
                            <th>Description</th>
                            <th>Ads Count</th>
                            <th>Created At</th>
                            <th style="width:150px;">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (Model != null && Model.Any())
                        {
                            foreach (var w in Model)
                            {
                                <tr>
                                    <td>@w.Name</td>
                                    <td>@w.Domain</td>
                                    <td>
                                        @if (!string.IsNullOrEmpty(w.Url))
                                        {
                                            <a href="@w.Url" target="_blank">@w.Url</a>
                                        }
                                    </td>
                                    <td>@(string.IsNullOrEmpty(w.Description) ? "-" : w.Description)</td>
                                    <td>@(w.Ads?.Count() ?? 0)</td>
                                    <td>@(w.CreatedAt.ToString("yyyy-MM-dd"))</td>
                                    <td>
                                        <a class="btn btn-sm btn-outline-primary" asp-controller="Websites" asp-action="Edit" asp-route-id="@w.Id">Edit</a>
                                        <a class="btn btn-sm btn-outline-info" asp-controller="Websites" asp-action="Details" asp-route-id="@w.Id">Details</a>
                                        <form asp-controller="Websites" asp-action="Delete" asp-route-id="@w.Id" method="post" class="d-inline" onsubmit="return confirm('Delete this website?');">
                                            <button type="submit" class="btn btn-sm btn-danger">Delete</button>
                                        </form>
                                    </td>
                                </tr>
                            }
                        }
                        else
                        {
                            <tr>
                                <td colspan="7" class="text-center text-muted">You haven’t added any websites yet.</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>

</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        (function () {
            let publisherChart;

            function showError(msg) {
                const el = document.getElementById('chartError');
                el.style.display = 'block';
                el.textContent = msg;
            }

            function clearError() {
                const el = document.getElementById('chartError');
                el.style.display = 'none';
                el.textContent = '';
            }

            async function loadSiteStats() {
                clearError();
                const from = document.getElementById('fromDate').value;
                const to = document.getElementById('toDate').value;
                const qs = (from && to) ? `?from=${encodeURIComponent(from)}&to=${encodeURIComponent(to)}` : '';
                const url = '/Analytics/GetPublisherSiteStats' + qs;

                try {
                    const res = await fetch(url, { credentials: 'same-origin' });
                    if (!res.ok) {
                        showError(`Analytics API error: ${res.status}`);
                        return;
                    }

                    const data = await res.json();
                    const labels = data.map(d => d.date);
                    const clicks = data.map(d => d.totalClicks);
                    const impressions = data.map(d => d.totalImpressions);

                    renderChart(labels, clicks, impressions);
                } catch (err) {
                    console.error(err);
                    showError('Failed to load analytics.');
                }
            }

            function renderChart(labels, clicks, impressions) {
                const ctx = document.getElementById('publisherChart').getContext('2d');
                if (publisherChart) publisherChart.destroy();

                publisherChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Clicks',
                                data: clicks,
                                borderColor: '#007bff',
                                backgroundColor: 'rgba(0,123,255,0.08)',
                                tension: 0.3,
                                fill: true,
                            },
                            {
                                label: 'Impressions',
                                data: impressions,
                                borderColor: '#28a745',
                                backgroundColor: 'rgba(40,167,69,0.08)',
                                tension: 0.3,
                                fill: true,
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { position: 'bottom' }
                        },
                        scales: {
                            y: { beginAtZero: true }
                        }
                    }
                });
            }

            document.getElementById('filterBtn').addEventListener('click', (e) => {
                e.preventDefault();
                loadSiteStats();
            });

            document.getElementById('resetBtn').addEventListener('click', (e) => {
                e.preventDefault();
                document.getElementById('fromDate').value = '';
                document.getElementById('toDate').value = '';
                loadSiteStats();
            });

            document.addEventListener('DOMContentLoaded', loadSiteStats);
        })();
    </script>
} *@
@model IEnumerable<AdSystem.ViewModels.PublisherSiteViewModel>

@{
    ViewData["Title"] = "لوحة الناشر (المواقع)";
}

<div class="container mt-5">

    <h2 class="mb-4 text-center fw-bold">🌐 لوحة تحكم الناشر</h2>

    <!-- Summary Cards -->
    <div class="row g-3 mb-4 text-center">
        <div class="col-md-3">
            <div class="card shadow-sm border-0 rounded-4 p-3 bg-primary text-white">
                <h5>إجمالي المواقع</h5>
                <h3>@ViewBag.TotalWebsites</h3>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow-sm border-0 rounded-4 p-3 bg-info text-white">
                <h5>إجمالي الإعلانات</h5>
                <h3>@ViewBag.TotalAds</h3>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow-sm border-0 rounded-4 p-3 bg-success text-white">
                <h5>إجمالي النقرات</h5>
                <h3>@ViewBag.TotalClicks</h3>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow-sm border-0 rounded-4 p-3 bg-warning text-dark">
                <h5>إجمالي الظهور</h5>
                <h3>@ViewBag.TotalImpressions</h3>
            </div>
        </div>
    </div>

    <!-- Chart Section -->
    <div class="card shadow-sm border-0 p-4 mb-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="fw-semibold">📈 أداء المواقع</h5>
            <button class="btn btn-outline-primary btn-sm" onclick="loadSiteStats()">🔄 تحديث البيانات</button>
        </div>
        <canvas id="siteChart" height="120"></canvas>
    </div>

    <!-- Table Section -->
    <div class="card shadow-sm border-0 p-4">
        <h5 class="mb-3 fw-semibold">📊 تفاصيل المواقع</h5>
        <div class="table-responsive">
            <table class="table table-striped align-middle text-center">
                <thead class="table-light">
                    <tr>
                        <th>#</th>
                        <th>اسم الموقع</th>
                        <th>الرابط</th>
                        <th>عدد الإعلانات</th>
                        <th>النقرات</th>
                        <th>الظهور</th>
                        <th>تاريخ الإنشاء</th>
                    </tr>
                </thead>
                <tbody>
                    @if (Model != null && Model.Any())
                    {
                        var index = 1;
                        foreach (var site in Model)
                        {
                            <tr>
                                <td>@index</td>
                                <td>@site.Name</td>
                                <td>
                                    <a href="@site.Url" target="_blank" class="text-decoration-none">
                                        @site.Url
                                    </a>
                                </td>
                                <td>@site.AdsCount</td>
                                <td>@site.TotalClicks</td>
                                <td>@site.TotalImpressions</td>
                                <td>@site.CreatedAt.ToString("yyyy-MM-dd")</td>
                            </tr>
                            index++;
                        }
                    }
                    else
                    {
                        <tr>
                            <td colspan="7" class="text-muted">لا توجد مواقع بعد</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>

</div>

@section Scripts {
    <script>
        let siteChart;

        async function loadSiteStats() {
            try {
                const res = await fetch('/Analytics/GetPublisherSiteStats');
                if (!res.ok) throw new Error("Network error");
                const data = await res.json();

                const labels = data.map(d => d.websiteName || d.WebsiteName);
                const clicks = data.map(d => d.totalClicks || d.TotalClicks);
                const impressions = data.map(d => d.totalImpressions || d.TotalImpressions);

                renderSiteChart(labels, clicks, impressions);
            } catch (err) {
                console.error("Failed to load site stats", err);
            }
        }

        function renderSiteChart(labels, clicks, impressions) {
            const ctx = document.getElementById('siteChart').getContext('2d');
            if (siteChart) siteChart.destroy();

            siteChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels,
                    datasets: [
                        {
                            label: 'النقرات (Clicks)',
                            data: clicks,
                            backgroundColor: 'rgba(0, 123, 255, 0.7)'
                        },
                        {
                            label: 'الظهور (Impressions)',
                            data: impressions,
                            backgroundColor: 'rgba(40, 167, 69, 0.7)'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'top' },
                        tooltip: {
                            callbacks: {
                                label: (ctx) => `${ctx.dataset.label}: ${ctx.parsed.y.toLocaleString()}`
                            }
                        }
                    },
                    scales: {
                        x: { title: { display: true, text: 'الموقع' } },
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        // Auto load chart
        loadSiteStats();
    </script>
}
